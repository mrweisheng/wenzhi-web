{"version":3,"file":"index-BGMiNgFH.js","sources":["../../src/views/roles/index.vue"],"sourcesContent":["<template>\n  <div class=\"app-container\">\n    <!-- 全屏加载 -->\n    <div \n      v-if=\"fullscreenLoading\" \n      class=\"fullscreen-loading\"\n    >\n      <el-loading\n        :visible=\"true\"\n        fullscreen\n        text=\"正在加载权限数据...\"\n        background=\"rgba(0, 0, 0, 0.7)\"\n      />\n    </div>\n\n    <div class=\"toolbar\">\n      <el-button type=\"primary\" @click=\"handleAdd\">新增角色</el-button>\n    </div>\n\n    <el-table\n      v-loading=\"loading\"\n      :data=\"roleList\"\n      style=\"width: 100%; margin-top: 20px\"\n      :row-key=\"(row) => row.id\"\n      :tree-props=\"{ children: 'children' }\"\n    >\n      <el-table-column prop=\"id\" label=\"ID\" width=\"80\" />\n      <el-table-column prop=\"role_name\" label=\"角色名称\" />\n      <el-table-column prop=\"description\" label=\"描述\" />\n      <el-table-column prop=\"created_at\" label=\"创建时间\" width=\"180\">\n        <template #default=\"{ row }\">\n          {{ formatDate(row.created_at) }}\n        </template>\n      </el-table-column>\n      <el-table-column label=\"操作\" width=\"250\" fixed=\"right\">\n        <template #default=\"{ row }\">\n          <el-button type=\"primary\" link @click=\"handleEdit(row)\">编辑</el-button>\n          <el-button \n            type=\"primary\" \n            link \n            @click=\"handlePermission(row)\"\n            :loading=\"permissionLoading && currentRoleId === row.id\"\n          >\n            权限设置\n          </el-button>\n          <el-button type=\"danger\" link @click=\"handleDelete(row)\">删除</el-button>\n        </template>\n      </el-table-column>\n    </el-table>\n\n    <!-- 角色表单对话框 -->\n    <el-dialog\n      :title=\"dialogTitle\"\n      v-model=\"dialogVisible\"\n      width=\"500px\"\n      @close=\"resetForm\"\n    >\n      <el-form\n        ref=\"formRef\"\n        :model=\"roleForm\"\n        :rules=\"rules\"\n        label-width=\"80px\"\n      >\n        <el-form-item label=\"角色名称\" prop=\"role_name\">\n          <el-input v-model=\"roleForm.role_name\" placeholder=\"请输入角色名称\" />\n        </el-form-item>\n      </el-form>\n      <template #footer>\n        <el-button @click=\"dialogVisible = false\">取消</el-button>\n        <el-button type=\"primary\" @click=\"handleSubmit\" :loading=\"submitting\">\n          确定\n        </el-button>\n      </template>\n    </el-dialog>\n\n    <!-- 权限设置对话框 -->\n    <el-dialog\n      title=\"权限设置\"\n      v-model=\"permissionDialogVisible\"\n      width=\"500px\"\n      :close-on-click-modal=\"false\"\n      :destroy-on-close=\"true\"\n      class=\"permission-dialog\"\n    >\n      <div v-loading=\"permissionLoading\" class=\"permission-content\">\n        <div class=\"permission-header\">\n          <h3>为角色 \"{{ currentRoleName }}\" 分配权限</h3>\n          <p class=\"permission-tip\">请选择该角色可访问的菜单和功能</p>\n        </div>\n        <el-tree\n          ref=\"treeRef\"\n          :data=\"menuTree\"\n          show-checkbox\n          node-key=\"id\"\n          :props=\"{ label: 'name' }\"\n          :default-checked-keys=\"selectedMenus\"\n          class=\"permission-tree\"\n          style=\"max-height: 400px; overflow-y: auto\"\n        />\n      </div>\n      <template #footer>\n        <div class=\"dialog-footer\">\n          <el-button @click=\"permissionDialogVisible = false\">取消</el-button>\n          <el-button type=\"primary\" @click=\"handlePermissionSubmit\" :loading=\"submitting\">\n            保存权限设置\n          </el-button>\n        </div>\n      </template>\n    </el-dialog>\n\n    \n  </div>\n</template>\n\n<script setup>\nimport { ref, onMounted, watch } from 'vue'\nimport { ElMessage, ElMessageBox } from 'element-plus'\nimport { getRoles, createRole, updateRole, deleteRole, getRoleMenus } from '@/api/role'\nimport { formatDate } from '@/utils/format'\nimport { getMenus } from '@/api/menu'\nimport { formatDateRange } from '@/utils/date'\n\nconst loading = ref(false)\nconst roleList = ref([])\nconst dialogVisible = ref(false)\nconst dialogTitle = ref('')\nconst permissionDialogVisible = ref(false)\nconst submitting = ref(false)\n\nconst formRef = ref()\n\nconst roleForm = ref({\n  role_name: '',\n  description: '',\n  menu_ids: []\n})\n\nconst rules = {\n  role_name: [\n    { required: true, message: '请输入角色名称', trigger: 'blur' },\n    { min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur' }\n  ]\n}\n\n// 查询参数\nconst queryParams = ref({\n  page: 1,\n  pageSize: 10,\n  role_name: '',\n  startTime: '',\n  endTime: ''\n})\n\n// 获取角色列表\nconst getRoleList = async () => {\n  try {\n    loading.value = true\n    const res = await getRoles()\n    roleList.value = Array.isArray(res.data.data) ? res.data.data : []\n  } catch (error) {\n    console.error('Get roles error:', error)\n    roleList.value = []\n  } finally {\n    loading.value = false\n  }\n}\n\n// 新增角色\nconst handleAdd = () => {\n  dialogTitle.value = '新增角色'\n  dialogVisible.value = true\n}\n\n// 编辑角色\nconst handleEdit = (row) => {\n  dialogTitle.value = '编辑角色'\n  roleForm.value = { ...row }\n  dialogVisible.value = true\n}\n\n// 删除角色\nconst handleDelete = async (row) => {\n  try {\n    await ElMessageBox.confirm('确认删除该角色吗？', '提示', {\n      type: 'warning'\n    })\n    \n    await deleteRole(row.id)\n    ElMessage.success('删除成功')\n    getRoleList()\n  } catch (error) {\n    console.error('Delete role error:', error)\n  }\n}\n\n// 提交表单\nconst handleSubmit = async () => {\n  if (!formRef.value) return\n  \n  await formRef.value.validate()\n  \n  try {\n    submitting.value = true\n    if (roleForm.value.id) {\n      await updateRole(roleForm.value.id, roleForm.value)\n      ElMessage.success('更新成功')\n    } else {\n      await createRole(roleForm.value)\n      ElMessage.success('创建成功')\n    }\n    dialogVisible.value = false\n    getRoleList()\n  } catch (error) {\n    console.error('Submit role error:', error)\n  } finally {\n    submitting.value = false\n  }\n}\n\n// 重置表单\nconst resetForm = () => {\n  if (formRef.value) {\n    formRef.value.resetFields()\n  }\n  roleForm.value = {\n    role_name: '',\n    description: '',\n    menu_ids: []\n  }\n}\n\n// 权限相关\nconst treeRef = ref()\nconst menuTree = ref([])\nconst selectedMenus = ref([])\nconst currentRoleId = ref()\nconst currentRoleName = ref('')\nconst permissionLoading = ref(false)\n\n// 添加全局加载状态\nconst fullscreenLoading = ref(false)\n\n// 获取所有菜单\nconst getMenuList = async () => {\n  try {\n    const res = await getMenus()\n    console.log('菜单数据:', res.data.data)\n    if (Array.isArray(res.data.data)) {\n      menuTree.value = res.data.data\n    } else {\n      menuTree.value = []\n      console.error('返回的菜单数据格式不正确')\n    }\n  } catch (error) {\n    console.error('Get menus error:', error)\n    menuTree.value = []\n  }\n}\n\n// 打开权限设置对话框\nconst handlePermission = async (row) => {\n  try {\n    // 显示全屏加载\n    fullscreenLoading.value = true\n    currentRoleId.value = row.id\n    currentRoleName.value = row.role_name\n    \n    const [menuRes, roleMenuRes] = await Promise.all([\n      getMenus(),\n      getRoleMenus(row.id)\n    ])\n    \n    if (Array.isArray(menuRes.data.data)) {\n      menuTree.value = menuRes.data.data\n    } else {\n      menuTree.value = []\n      console.error('返回的菜单数据格式不正确')\n    }\n    \n    selectedMenus.value = roleMenuRes.data.data.map(menu => menu.id)\n    \n    permissionDialogVisible.value = true\n  } catch (error) {\n    console.error('Get role menus error:', error)\n    ElMessage.error('获取权限数据失败')\n  } finally {\n    // 关闭全屏加载\n    fullscreenLoading.value = false\n  }\n}\n\n// 提交权限设置\nconst handlePermissionSubmit = async () => {\n  if (!currentRoleId.value || !treeRef.value) return\n  \n  try {\n    submitting.value = true\n    const checkedKeys = treeRef.value.getCheckedKeys()\n    console.log('选中的权限:', checkedKeys)\n    await updateRole(currentRoleId.value, {\n      menu_ids: checkedKeys\n    })\n    ElMessage.success('权限设置成功')\n    permissionDialogVisible.value = false\n  } catch (error) {\n    console.error('Update role permissions error:', error)\n  } finally {\n    submitting.value = false\n  }\n}\n\n// 日期范围\nconst dateRange = ref()\n\n// 监听日期变化\nwatch(dateRange, (val) => {\n  const { startTime, endTime } = formatDateRange(val)\n  queryParams.value.startTime = startTime\n  queryParams.value.endTime = endTime\n})\n\n// 重置查询\nconst resetQuery = () => {\n  queryParams.value = {\n    page: 1,\n    pageSize: 10,\n    role_name: '',\n    startTime: '',\n    endTime: ''\n  }\n  dateRange.value = undefined\n  getRoleList()\n}\n\nonMounted(() => {\n  getRoleList()\n})\n</script>\n\n<style scoped>\n.app-container {\n  padding: 20px;\n}\n.toolbar {\n  padding: 10px 0;\n}\n\n/* 权限对话框样式 */\n:deep(.permission-dialog) {\n  .el-dialog__body {\n    padding: 0;\n  }\n  \n  .el-dialog__header {\n    padding: 20px 24px;\n    margin: 0;\n    border-bottom: 1px solid #e4e7ed;\n    background-color: #f5f7fa;\n  }\n  \n  .el-dialog__footer {\n    padding: 16px 24px;\n    border-top: 1px solid #e4e7ed;\n    background-color: #f5f7fa;\n  }\n}\n\n.permission-content {\n  padding: 20px;\n  \n  .permission-header {\n    margin-bottom: 16px;\n    \n    h3 {\n      margin: 0 0 8px;\n      font-size: 16px;\n      color: #303133;\n    }\n    \n    .permission-tip {\n      margin: 0;\n      color: #909399;\n      font-size: 13px;\n    }\n  }\n}\n\n.permission-tree {\n  border: 1px solid #e4e7ed;\n  border-radius: 4px;\n  padding: 12px;\n  background-color: #f9fafc;\n}\n\n.dialog-footer {\n  display: flex;\n  justify-content: flex-end;\n  gap: 12px;\n}\n\n/* 添加全屏加载样式 */\n.fullscreen-loading {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  z-index: 9999;\n  background-color: rgba(0, 0, 0, 0.7);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n:deep(.el-loading-spinner) {\n  .circular {\n    width: 42px;\n    height: 42px;\n  }\n  .el-loading-text {\n    color: #fff;\n    font-size: 16px;\n    margin: 8px 0;\n  }\n}\n</style>\n"],"names":["loading","ref","roleList","dialogVisible","dialogTitle","permissionDialogVisible","submitting","formRef","roleForm","rules","queryParams","getRoleList","res","getRoles","error","handleAdd","handleEdit","row","handleDelete","ElMessageBox","deleteRole","ElMessage","handleSubmit","updateRole","createRole","resetForm","treeRef","menuTree","selectedMenus","currentRoleId","currentRoleName","permissionLoading","fullscreenLoading","handlePermission","menuRes","roleMenuRes","getMenus","getRoleMenus","menu","handlePermissionSubmit","checkedKeys","dateRange","watch","val","startTime","endTime","formatDateRange","onMounted"],"mappings":"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"}