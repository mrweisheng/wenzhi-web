{"version":3,"file":"index-D5IZ_qn1.js","sources":["../../src/views/roles/index.vue"],"sourcesContent":["<template>\r\n  <div class=\"app-container\">\r\n    <div class=\"toolbar\">\r\n      <el-button type=\"primary\" @click=\"handleAdd\">新增角色</el-button>\r\n    </div>\r\n\r\n    <el-table v-loading=\"loading\" :data=\"roleList\" style=\"width: 100%; margin-top: 20px\">\r\n      <el-table-column prop=\"id\" label=\"ID\" width=\"80\" />\r\n      <el-table-column prop=\"role_name\" label=\"角色名称\" />\r\n      <el-table-column prop=\"description\" label=\"描述\" />\r\n      <el-table-column prop=\"created_at\" label=\"创建时间\" width=\"180\">\r\n        <template #default=\"{ row }\">\r\n          {{ formatDate(row.created_at) }}\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column label=\"操作\" width=\"250\" fixed=\"right\">\r\n        <template #default=\"{ row }\">\r\n          <el-button type=\"primary\" link @click=\"handleEdit(row)\">编辑</el-button>\r\n          <el-button type=\"primary\" link @click=\"handlePermission(row)\">权限设置</el-button>\r\n          <el-button type=\"danger\" link @click=\"handleDelete(row)\">删除</el-button>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <!-- 角色表单对话框 -->\r\n    <el-dialog\r\n      :title=\"dialogTitle\"\r\n      v-model=\"dialogVisible\"\r\n      width=\"500px\"\r\n      @close=\"resetForm\"\r\n    >\r\n      <el-form\r\n        ref=\"formRef\"\r\n        :model=\"roleForm\"\r\n        :rules=\"rules\"\r\n        label-width=\"80px\"\r\n      >\r\n        <el-form-item label=\"角色名称\" prop=\"role_name\">\r\n          <el-input v-model=\"roleForm.role_name\" placeholder=\"请输入角色名称\" />\r\n        </el-form-item>\r\n      </el-form>\r\n      <template #footer>\r\n        <el-button @click=\"dialogVisible = false\">取消</el-button>\r\n        <el-button type=\"primary\" @click=\"handleSubmit\" :loading=\"submitting\">\r\n          确定\r\n        </el-button>\r\n      </template>\r\n    </el-dialog>\r\n\r\n    <!-- 权限设置对话框 -->\r\n    <el-dialog\r\n      title=\"权限设置\"\r\n      v-model=\"permissionDialogVisible\"\r\n      width=\"600px\"\r\n    >\r\n      <el-tree\r\n        ref=\"treeRef\"\r\n        :data=\"menuTree\"\r\n        show-checkbox\r\n        node-key=\"id\"\r\n        :props=\"{ label: 'name' }\"\r\n        :default-checked-keys=\"selectedMenus\"\r\n      />\r\n      <template #footer>\r\n        <el-button @click=\"permissionDialogVisible = false\">取消</el-button>\r\n        <el-button type=\"primary\" @click=\"handlePermissionSubmit\" :loading=\"submitting\">\r\n          确定\r\n        </el-button>\r\n      </template>\r\n    </el-dialog>\r\n\r\n    <!-- 日期范围选择器 -->\r\n    <el-date-picker\r\n      v-model=\"dateRange\"\r\n      type=\"daterange\"\r\n      value-format=\"YYYY-MM-DD\"\r\n      range-separator=\"至\"\r\n      start-placeholder=\"开始日期\"\r\n      end-placeholder=\"结束日期\"\r\n    />\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, onMounted, watch } from 'vue'\r\nimport { ElMessage, ElMessageBox } from 'element-plus'\r\nimport type { FormInstance, FormRules } from 'element-plus'\r\nimport type { Role, RoleForm } from '@/types/role'\r\nimport { getRoles, createRole, updateRole, deleteRole, getRoleMenus } from '@/api/role'\r\nimport { formatDate } from '@/utils/format'\r\nimport { getMenus } from '@/api/menu'\r\nimport type { DateModelType } from 'element-plus'\r\nimport { formatDateRange } from '@/utils/date'\r\n\r\nconst loading = ref(false)\r\nconst roleList = ref<Role[]>([])\r\nconst dialogVisible = ref(false)\r\nconst dialogTitle = ref('')\r\nconst permissionDialogVisible = ref(false)\r\nconst submitting = ref(false)\r\n\r\nconst formRef = ref<FormInstance>()\r\n\r\ninterface EditingRole extends RoleForm {\r\n  id?: number\r\n}\r\n\r\nconst roleForm = ref<EditingRole>({\r\n  role_name: '',\r\n  description: '',\r\n  menu_ids: []\r\n})\r\n\r\nconst rules: FormRules = {\r\n  role_name: [\r\n    { required: true, message: '请输入角色名称', trigger: 'blur' },\r\n    { min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur' }\r\n  ]\r\n}\r\n\r\n// 查询参数\r\nconst queryParams = ref({\r\n  page: 1,\r\n  pageSize: 10,\r\n  role_name: '',\r\n  startTime: '',\r\n  endTime: ''\r\n})\r\n\r\n// 获取角色列表\r\nconst getRoleList = async () => {\r\n  try {\r\n    loading.value = true\r\n    const res = await getRoles()\r\n    roleList.value = res.data\r\n  } catch (error) {\r\n    console.error('Get roles error:', error)\r\n  } finally {\r\n    loading.value = false\r\n  }\r\n}\r\n\r\n// 新增角色\r\nconst handleAdd = () => {\r\n  dialogTitle.value = '新增角色'\r\n  dialogVisible.value = true\r\n}\r\n\r\n// 编辑角色\r\nconst handleEdit = (row: Role) => {\r\n  dialogTitle.value = '编辑角色'\r\n  roleForm.value = { ...row }\r\n  dialogVisible.value = true\r\n}\r\n\r\n// 删除角色\r\nconst handleDelete = async (row: Role) => {\r\n  try {\r\n    await ElMessageBox.confirm('确认删除该角色吗？', '提示', {\r\n      type: 'warning'\r\n    })\r\n    \r\n    await deleteRole(row.id)\r\n    ElMessage.success('删除成功')\r\n    getRoleList()\r\n  } catch (error) {\r\n    console.error('Delete role error:', error)\r\n  }\r\n}\r\n\r\n// 提交表单\r\nconst handleSubmit = async () => {\r\n  if (!formRef.value) return\r\n  \r\n  await formRef.value.validate()\r\n  \r\n  try {\r\n    submitting.value = true\r\n    if (roleForm.value.id) {\r\n      await updateRole(roleForm.value.id, {\r\n        role_name: roleForm.value.role_name,\r\n        description: roleForm.value.description,\r\n        menu_ids: roleForm.value.menu_ids\r\n      })\r\n      ElMessage.success('更新成功')\r\n    } else {\r\n      await createRole({\r\n        role_name: roleForm.value.role_name,\r\n        description: roleForm.value.description,\r\n        menu_ids: roleForm.value.menu_ids\r\n      })\r\n      ElMessage.success('创建成功')\r\n    }\r\n    dialogVisible.value = false\r\n    getRoleList()\r\n  } catch (error) {\r\n    console.error('Submit role error:', error)\r\n  } finally {\r\n    submitting.value = false\r\n  }\r\n}\r\n\r\n// 重置表单\r\nconst resetForm = () => {\r\n  if (formRef.value) {\r\n    formRef.value.resetFields()\r\n  }\r\n  roleForm.value = {\r\n    role_name: '',\r\n    description: '',\r\n    menu_ids: []\r\n  }\r\n}\r\n\r\n// 权限相关\r\nconst treeRef = ref()\r\nconst menuTree = ref([])\r\nconst selectedMenus = ref<number[]>([])\r\nconst currentRoleId = ref<number>()\r\n\r\n// 获取所有菜单\r\nconst getMenuList = async () => {\r\n  try {\r\n    const res = await getMenus()\r\n    menuTree.value = res.data\r\n  } catch (error) {\r\n    console.error('Get menus error:', error)\r\n  }\r\n}\r\n\r\n// 打开权限设置对话框\r\nconst handlePermission = async (row: Role) => {\r\n  try {\r\n    currentRoleId.value = row.id\r\n    // 获取所有菜单\r\n    await getMenuList()\r\n    // 获取角色已有权限\r\n    const res = await getRoleMenus(row.id)\r\n    selectedMenus.value = res.data.map((menu: any) => menu.id)\r\n    permissionDialogVisible.value = true\r\n  } catch (error) {\r\n    console.error('Get role menus error:', error)\r\n  }\r\n}\r\n\r\n// 提交权限设置\r\nconst handlePermissionSubmit = async () => {\r\n  if (!currentRoleId.value || !treeRef.value) return\r\n  \r\n  try {\r\n    submitting.value = true\r\n    const checkedKeys = treeRef.value.getCheckedKeys()\r\n    await updateRole(currentRoleId.value, {\r\n      menu_ids: checkedKeys\r\n    })\r\n    ElMessage.success('权限设置成功')\r\n    permissionDialogVisible.value = false\r\n  } catch (error) {\r\n    console.error('Update role permissions error:', error)\r\n  } finally {\r\n    submitting.value = false\r\n  }\r\n}\r\n\r\n// 日期范围\r\nconst dateRange = ref<[DateModelType, DateModelType] | undefined>()\r\n\r\n// 监听日期变化\r\nwatch(dateRange, (val) => {\r\n  const { startTime, endTime } = formatDateRange(val)\r\n  queryParams.value.startTime = startTime\r\n  queryParams.value.endTime = endTime\r\n})\r\n\r\n// 重置查询\r\nconst resetQuery = () => {\r\n  queryParams.value = {\r\n    page: 1,\r\n    pageSize: 10,\r\n    role_name: '',\r\n    startTime: '',\r\n    endTime: ''\r\n  }\r\n  dateRange.value = undefined\r\n  getRoleList()\r\n}\r\n\r\nonMounted(() => {\r\n  getRoleList()\r\n})\r\n</script>\r\n\r\n<style scoped>\r\n.toolbar {\r\n  padding: 10px 0;\r\n}\r\n</style>\r\n"],"names":["loading","ref","roleList","dialogVisible","dialogTitle","permissionDialogVisible","submitting","formRef","roleForm","rules","queryParams","getRoleList","res","getRoles","error","handleAdd","handleEdit","row","handleDelete","ElMessageBox","deleteRole","ElMessage","handleSubmit","updateRole","createRole","resetForm","treeRef","menuTree","selectedMenus","currentRoleId","getMenuList","getMenus","handlePermission","getRoleMenus","menu","handlePermissionSubmit","checkedKeys","dateRange","watch","val","startTime","endTime","formatDateRange","onMounted"],"mappings":"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"}