import{d as Ce,r as c,a as Ue,af as ue,n as Te,H as He,b as f,o as v,c as m,f as t,e as a,w as o,g as I,M as Ne,h as y,F as X,q as Z,t as M,x as i,s as ee,E as D,ar as Re,a3 as ce,P as L,an as ve}from"./index-4kIbEQav.js";import{f as me}from"./format-DZvyx3OM.js";import{a as je,g as pe,b as Le,c as qe,d as Ye}from"./issues-CK2GnHxB.js";import{_ as $e}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ae={class:"app-container"},Fe={class:"search-area bg-white rounded-lg p-3"},Be={class:"flex items-center space-x-4"},Ee={key:0,class:"flex justify-center items-center py-12"},Pe={key:1,class:"flex flex-col justify-center items-center py-20"},Ke={key:2,class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6"},Oe=["onClick"],Qe={class:"issue-card-content"},Ge={class:"issue-card-header"},Je={class:"issue-id"},We={class:"issue-card-title"},Xe={class:"tags-group"},Ze={class:"time-section mb-4"},et={class:"time-tag create-time"},tt={class:"status-flow-section mb-5"},st={class:"users-section"},at={class:"users-row"},lt={class:"user-cell"},ot={class:"user-info"},nt={class:"user-name"},it={class:"user-cell"},rt={class:"user-info"},dt={class:"user-name"},ut={key:3,class:"text-center py-4"},ct={class:"loading-more"},vt={key:0,class:"flex items-center space-x-4"},mt={class:"text-2xl font-bold"},pt={key:1,class:"flex items-center space-x-4"},gt={key:0,class:"flex justify-center items-center py-12"},ft={key:1,class:"issue-detail space-y-6 p-6"},_t={class:"info-card bg-white rounded-lg p-6 shadow-sm"},yt={class:"flex items-center gap-3 mb-4"},bt={class:"issue-number font-mono text-gray-500 text-base"},ht={class:"text-xl font-semibold text-gray-900"},xt={class:"flex items-center justify-between mb-6"},wt={class:"tags-row flex items-center gap-3"},Vt={class:"tag-item"},kt={class:"tag-item"},It={class:"issue-timeline mb-6"},Mt={class:"timeline-item"},Dt={class:"timeline-content"},zt={class:"text-base font-medium"},St={class:"timeline-item"},Ct={class:"timeline-content"},Ut={class:"deadline-info"},Tt={class:"text-base font-medium"},Ht={class:"users-info"},Nt={class:"flex justify-between items-start"},Rt={class:"user-box"},jt={class:"user-detail"},Lt={class:"user-info"},qt={class:"user-name"},Yt={class:"user-box"},$t={class:"user-detail"},At={class:"user-info"},Ft={class:"user-name"},Bt={class:"info-card bg-white rounded-lg p-6 shadow-sm"},Et={class:"description-content"},Pt={class:"info-card bg-white rounded-lg p-6 shadow-sm"},Kt={class:"space-y-5"},Ot={class:"chat-records"},Qt={class:"flex items-start gap-3"},Gt={class:"flex-grow"},Jt={class:"flex items-center justify-between mb-1"},Wt={class:"font-medium text-gray-900"},Xt={class:"text-sm text-gray-500"},Zt=["innerHTML"],es={key:0,class:"add-record-section mt-8"},ts={class:"mb-5"},ss={class:"status-selector mb-4"},as={class:"flex justify-end mt-5"},ls={key:1,class:"text-center text-gray-500 py-8"},os={class:"flex space-x-4"},ns={class:"create-form"},is={class:"grid grid-cols-2 gap-4"},rs={class:"user-option flex items-center justify-between w-full"},ds={class:"flex items-center"},us={class:"user-name"},cs={class:"user-role text-xs text-gray-500"},vs={class:"grid grid-cols-2 gap-4"},ms={class:"dialog-footer"},ps=Ce({__name:"index",setup(gs){const F=c(!1),B=c(!1),E=c(!1),U=c(!1),T=c(1),z=c(10),ge=c(0),q=c(!1),_=c(!0),Y=c(""),$=c(""),H=c(!1),n=c(null),S=c(""),V=c(""),N=c(!1),A=c(null),p=c({title:"",priority:"medium",status:"pending",description:"",deadline:"",assignee:""}),fe={title:[{required:!0,message:"请输入问题标题",trigger:"blur"}],priority:[{required:!0,message:"请选择优先级",trigger:"change"}],assignee:[{required:!0,message:"请选择负责人",trigger:"change"}],deadline:[{required:!0,message:"请选择截止日期",trigger:"change"}],description:[{required:!0,message:"请输入问题描述",trigger:"blur"}]},R=c([]),h=c([]),te=Ue(),se=ue(()=>{var s;return((s=te.userInfo)==null?void 0:s.id)||null}),_e=ue(()=>{var u,b;if(!n.value||!se.value)return console.log("不显示添加记录区域，原因:",n.value?"当前用户ID未获取":"问题详情不存在"),!1;const s=Number(se.value),e=(u=n.value.creator)!=null&&u.id?Number(n.value.creator.id):null,r=(b=n.value.assignee)!=null&&b.id?Number(n.value.assignee.id):null,g=e===s,d=r===s;return console.log("权限检查详情:",{当前用户ID:s,创建者ID:e,负责人ID:r,是创建者:g,是负责人:d,可添加记录:g||d}),g||d}),ye=async()=>{try{const s=await je();s.data.code===0&&s.data.data?(R.value=s.data.data.map(e=>({id:e.id,name:e.real_name||e.username,avatar:x(e.real_name||e.username),role:e.role_name||be(e.role_id)})),console.log("获取到的用户列表:",R.value)):(R.value=[{id:"1",name:"系统管理员",avatar:x("系统管理员"),role:"管理员"},{id:"2",name:"技术支持",avatar:x("技术支持"),role:"技术人员"}],console.warn("获取用户列表返回数据格式不符，使用默认数据",s.data))}catch(s){console.error("获取用户列表失败:",s),D.error("获取用户列表失败，将使用默认数据"),R.value=[{id:"1",name:"系统管理员",avatar:x("系统管理员"),role:"管理员"},{id:"2",name:"技术支持",avatar:x("技术支持"),role:"技术人员"}]}},be=s=>({1:"管理员",2:"普通用户",3:"技术人员"})[s]||"用户",P=async()=>{F.value=!0;try{const s=await pe({page:T.value,pageSize:z.value,status:$.value,keyword:Y.value});s.data&&s.data.data?s.data.data.items?(h.value=s.data.data.items,ge.value=s.data.data.total,T.value=s.data.data.currentPage,_.value=s.data.data.items.length===z.value):Array.isArray(s.data.data)?(h.value=s.data.data,_.value=s.data.data.length===z.value):(h.value=[],_.value=!1):(h.value=[],_.value=!1)}catch(s){console.error("获取问题列表失败:",s),D.error("获取问题列表失败"),h.value=[],_.value=!1}finally{F.value=!1}},ae=async s=>{B.value=!0;try{const e=await Ye(s);n.value=e.data.data}catch(e){console.error("获取问题详情失败:",e),D.error("获取问题详情失败"),H.value=!1}finally{B.value=!1}},K=s=>{if(!s)return!1;const e=new Date(s),r=new Date,g=e.getTime()-r.getTime(),d=Math.ceil(g/(1e3*60*60*24));return d>=0&&d<=7},O=s=>{if(!s)return"未设置";const e=new Date(s);if(isNaN(e.getTime()))return s;const r=e.getFullYear(),g=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0"),u=String(e.getHours()).padStart(2,"0"),b=String(e.getMinutes()).padStart(2,"0");return`${r}-${g}-${d} ${u}:${b}`},Q=s=>({pending:"info",processing:"warning",completed:"success"})[s]||"info",G=s=>({pending:"待处理",processing:"处理中",completed:"已完成"})[s]||s,le=s=>({high:"danger",medium:"warning",low:"info"})[s]||"info",oe=s=>({high:"高优先级",medium:"中优先级",low:"低优先级"})[s]||s,x=s=>`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(s||"default")}`,ne=()=>{ke(),P()},ie=()=>{N.value=!0},he=s=>{ae(s.id),H.value=!0},xe=()=>{H.value=!1},we=async()=>{if(!(!n.value||!S.value||!V.value)){U.value=!0;try{const s=await Le(n.value.id,{content:S.value,newStatus:V.value});n.value&&(n.value.status=V.value),await ae(n.value.id),S.value="",V.value="",D.success("添加处理记录成功")}catch(s){console.error("添加处理记录失败:",s),D.error("添加处理记录失败")}finally{U.value=!1}}},Ve=async()=>{A.value&&A.value.validate(async s=>{var e;if(s){E.value=!0;try{let r=p.value.deadline;r&&typeof r=="object"&&(r=O(r)),await qe({title:p.value.title,priority:p.value.priority,status:"pending",description:p.value.description,deadline:r,assigneeId:p.value.assignee}),P(),(e=A.value)==null||e.resetFields(),N.value=!1,D.success("创建问题成功")}catch(r){console.error("创建问题失败:",r),D.error("创建问题失败")}finally{E.value=!1}}})},re=async s=>{const e=s.target,r=e.scrollHeight,g=e.scrollTop,d=e.clientHeight;if(r-g-d<100&&_.value&&!q.value){q.value=!0,T.value++;try{const u=await pe({page:T.value,pageSize:z.value,status:$.value,keyword:Y.value});u.data&&u.data.data?u.data.data.items&&u.data.data.items.length>0?(h.value.push(...u.data.data.items),_.value=u.data.data.items.length===z.value):Array.isArray(u.data.data)&&u.data.data.length>0?(h.value.push(...u.data.data),_.value=u.data.data.length===z.value):_.value=!1:_.value=!1}catch(u){console.error("加载更多失败:",u),_.value=!1}finally{q.value=!1}}},ke=()=>{T.value=1,_.value=!0,q.value=!1,h.value=[]};return Te(()=>{console.log("当前登录用户信息:",te.userInfo),ye(),P();const s=document.querySelector(".app-container");s&&s.addEventListener("scroll",re)}),He(()=>{const s=document.querySelector(".app-container");s&&s.removeEventListener("scroll",re)}),(s,e)=>{var de;const r=f("el-icon"),g=f("el-input"),d=f("el-option"),u=f("el-select"),b=f("el-button"),J=f("el-spinner"),Ie=f("el-empty"),k=f("el-tag"),C=f("el-avatar"),Me=f("el-drawer"),j=f("el-form-item"),De=f("el-date-picker"),ze=f("el-form"),Se=f("el-dialog");return v(),m("div",Ae,[t("div",Fe,[t("div",Be,[a(g,{modelValue:Y.value,"onUpdate:modelValue":e[0]||(e[0]=l=>Y.value=l),placeholder:"搜索问题...",class:"!w-[260px]",size:"large",onKeyup:Ne(ne,["enter"])},{prefix:o(()=>[a(r,{class:"text-gray-400"},{default:o(()=>[a(I(Re))]),_:1})]),_:1},8,["modelValue"]),a(u,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=l=>$.value=l),placeholder:"所有状态",class:"!w-[150px]",size:"large",onChange:ne},{default:o(()=>[a(d,{label:"所有状态",value:""}),a(d,{label:"待处理",value:"pending"}),a(d,{label:"处理中",value:"processing"}),a(d,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"]),a(b,{type:"primary",onClick:ie,class:"!min-w-[100px]",size:"large"},{default:o(()=>e[12]||(e[12]=[y(" 新建问题 ")])),_:1})])]),F.value?(v(),m("div",Ee,[a(J,{text:"加载中..."})])):h.value.length===0?(v(),m("div",Pe,[a(Ie,{description:"暂无问题"}),a(b,{type:"primary",onClick:ie,class:"mt-4"},{default:o(()=>e[13]||(e[13]=[y("新建问题")])),_:1})])):(v(),m("div",Ke,[(v(!0),m(X,null,Z(h.value,l=>(v(),m("div",{key:l.id,class:"issue-card bg-white rounded-lg shadow-sm overflow-hidden cursor-pointer hover:shadow-md transition-shadow duration-300",onClick:W=>he(l)},[t("div",Qe,[t("div",Ge,[t("span",Je,"#"+i(l.id),1),t("h3",We,i(l.title),1),t("div",Xe,[a(k,{type:le(l.priority),effect:"light",class:"priority-tag"},{default:o(()=>[y(i(oe(l.priority)),1)]),_:2},1032,["type"]),a(k,{type:Q(l.status),effect:"light",class:"status-tag"},{default:o(()=>[y(i(G(l.status)),1)]),_:2},1032,["type"])])]),t("div",Ze,[t("div",et,[a(r,{class:"mr-1"},{default:o(()=>[a(I(ce))]),_:1}),t("span",null,"创建: "+i(I(me)(l.createTime)),1)]),l.deadline?(v(),m("div",{key:0,class:L(["time-tag deadline-tag",K(l.deadline)?"deadline-near":""])},[a(r,{class:"mr-1"},{default:o(()=>[a(I(ve))]),_:1}),t("span",null,"截止: "+i(O(l.deadline)),1),K(l.deadline)?(v(),ee(k,{key:0,type:"danger",effect:"light",size:"small",class:"ml-2"},{default:o(()=>e[14]||(e[14]=[y(" 即将到期 ")])),_:1})):M("",!0)],2)):M("",!0)]),t("div",tt,[t("div",{class:L(["status-flow",{"flow-pending":l.status==="pending","flow-processing":l.status==="processing","flow-completed":l.status==="completed"}])},[t("div",{class:L(["status-step",{"status-pending":l.status==="pending","status-completed":["processing","completed"].includes(l.status),"status-current":l.status==="pending"}])},e[15]||(e[15]=[t("div",{class:"status-dot"},null,-1),t("span",{class:"status-text"},"待处理",-1)]),2),e[18]||(e[18]=t("div",{class:"status-line"},null,-1)),t("div",{class:L(["status-step",{"status-completed":l.status==="completed","status-current":l.status==="processing"}])},e[16]||(e[16]=[t("div",{class:"status-dot"},null,-1),t("span",{class:"status-text"},"处理中",-1)]),2),e[19]||(e[19]=t("div",{class:"status-line"},null,-1)),t("div",{class:L(["status-step",{"status-completed":l.status==="completed","status-current":!1}])},e[17]||(e[17]=[t("div",{class:"status-dot"},null,-1),t("span",{class:"status-text"},"已完成",-1)]),2)],2)]),t("div",st,[t("div",at,[t("div",lt,[e[20]||(e[20]=t("span",{class:"user-label"},"创建人:",-1)),t("div",ot,[a(C,{size:24,src:x(l.creator.name),class:"user-avatar"},null,8,["src"]),t("span",nt,i(l.creator.name),1)])]),t("div",it,[e[21]||(e[21]=t("span",{class:"user-label"},"负责人:",-1)),t("div",rt,[a(C,{size:24,src:x(l.assignee.name),class:"user-avatar"},null,8,["src"]),t("span",dt,i(l.assignee.name),1)])])])])])],8,Oe))),128))])),_.value?(v(),m("div",ut,[t("div",ct,[a(J,{class:"mr-2",size:"small"}),e[22]||(e[22]=t("span",{class:"text-gray-500"},"加载更多...",-1))])])):M("",!0),a(Me,{modelValue:H.value,"onUpdate:modelValue":e[4]||(e[4]=l=>H.value=l),title:((de=n.value)==null?void 0:de.title)||"问题详情",size:"55%","destroy-on-close":!0},{header:o(()=>[n.value?(v(),m("div",vt,[t("h2",mt,i(n.value.title),1),a(k,{type:Q(n.value.status),effect:"light",size:"large"},{default:o(()=>[y(i(G(n.value.status)),1)]),_:1},8,["type"])])):(v(),m("div",pt,e[23]||(e[23]=[t("h2",{class:"text-2xl font-bold"},"加载中...",-1)])))]),footer:o(()=>[t("div",os,[a(b,{onClick:xe},{default:o(()=>e[39]||(e[39]=[y(" 关闭 ")])),_:1})])]),default:o(()=>{var l,W;return[B.value?(v(),m("div",gt,[a(J,{text:"加载中..."})])):n.value?(v(),m("div",ft,[t("div",_t,[t("div",yt,[t("span",bt,"#"+i(n.value.id),1),t("h2",ht,i(n.value.title),1)]),t("div",xt,[t("div",wt,[t("div",Vt,[e[24]||(e[24]=t("span",{class:"tag-label text-gray-500"},"优先级",-1)),a(k,{type:le(n.value.priority),effect:"plain",class:"priority-tag",size:"large"},{default:o(()=>[y(i(oe(n.value.priority)),1)]),_:1},8,["type"])]),t("div",kt,[e[25]||(e[25]=t("span",{class:"tag-label text-gray-500"},"状态",-1)),a(k,{type:Q(n.value.status),effect:"plain",class:"status-tag",size:"large"},{default:o(()=>[y(i(G(n.value.status)),1)]),_:1},8,["type"])])])]),t("div",It,[t("div",Mt,[a(r,{class:"timeline-icon"},{default:o(()=>[a(I(ce))]),_:1}),t("div",Dt,[e[26]||(e[26]=t("div",{class:"text-sm text-gray-500"},"创建时间",-1)),t("div",zt,i(I(me)(n.value.createTime)),1)])]),e[29]||(e[29]=t("div",{class:"timeline-divider"},null,-1)),t("div",St,[a(r,{class:"timeline-icon"},{default:o(()=>[a(I(ve))]),_:1}),t("div",Ct,[e[28]||(e[28]=t("div",{class:"text-sm text-gray-500"},"截止时间",-1)),t("div",Ut,[t("span",Tt,i(O(n.value.deadline)),1),K(n.value.deadline)?(v(),ee(k,{key:0,type:"danger",effect:"light",size:"small",class:"ml-2"},{default:o(()=>e[27]||(e[27]=[y(" 即将到期 ")])),_:1})):M("",!0)])])])]),t("div",Ht,[t("div",Nt,[t("div",Rt,[e[31]||(e[31]=t("span",{class:"user-role-label"},"创建人",-1)),t("div",jt,[a(C,{size:40,src:x((l=n.value.creator)==null?void 0:l.name)},null,8,["src"]),t("div",Lt,[t("span",qt,i((W=n.value.creator)==null?void 0:W.name),1),e[30]||(e[30]=t("span",{class:"user-role"},"发起人",-1))])])]),t("div",Yt,[e[33]||(e[33]=t("span",{class:"user-role-label"},"负责人",-1)),t("div",$t,[a(C,{size:40,src:x(n.value.assignee.name)},null,8,["src"]),t("div",At,[t("span",Ft,i(n.value.assignee.name),1),e[32]||(e[32]=t("span",{class:"user-role"},"处理人",-1))])])])])])]),t("div",Bt,[e[34]||(e[34]=t("h3",{class:"text-lg font-semibold mb-4 text-gray-900 border-b pb-2"},"问题描述",-1)),t("p",Et,i(n.value.description),1)]),t("div",Pt,[e[38]||(e[38]=t("h3",{class:"text-lg font-semibold mb-4 text-gray-900 border-b pb-2"},"处理记录",-1)),t("div",Kt,[t("div",Ot,[(v(!0),m(X,null,Z(n.value.records,w=>(v(),m("div",{key:w.id,class:"chat-record-item mb-6"},[t("div",Qt,[a(C,{size:40,src:x(w.user.name),class:"flex-shrink-0"},null,8,["src"]),t("div",Gt,[t("div",Jt,[t("span",Wt,i(w.user.name+" : "),1),t("span",Xt,i(w.createTime),1)]),t("div",{class:"chat-bubble bg-gray-100 rounded-lg p-4 text-gray-800",innerHTML:w.content},null,8,Zt)])])]))),128))]),_e.value?(v(),m("div",es,[e[37]||(e[37]=t("h4",{class:"font-medium text-gray-900 mb-4 border-b pb-2"},"添加处理记录",-1)),t("div",ts,[a(g,{type:"textarea",modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=w=>S.value=w),placeholder:"请输入处理记录内容...",rows:5,disabled:U.value},null,8,["modelValue","disabled"])]),t("div",ss,[e[35]||(e[35]=t("div",{class:"label-required mb-2"},"更新问题状态",-1)),a(u,{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=w=>V.value=w),placeholder:"请选择要更新的状态",size:"large",disabled:U.value,class:"w-full"},{default:o(()=>[a(d,{label:"待处理",value:"pending"}),a(d,{label:"处理中",value:"processing"}),a(d,{label:"已完成",value:"completed"})]),_:1},8,["modelValue","disabled"])]),t("div",as,[a(b,{type:"primary",size:"large",onClick:we,loading:U.value,disabled:!S.value||!V.value},{default:o(()=>e[36]||(e[36]=[y(" 添加记录 ")])),_:1},8,["loading","disabled"])])])):M("",!0),n.value.records.length===0?(v(),m("div",ls," 暂无处理记录 ")):M("",!0)])])])):M("",!0)]}),_:1},8,["modelValue","title"]),a(Se,{modelValue:N.value,"onUpdate:modelValue":e[11]||(e[11]=l=>N.value=l),title:"新建问题",width:"650px","destroy-on-close":!0},{footer:o(()=>[t("div",ms,[a(b,{onClick:e[10]||(e[10]=l=>N.value=!1)},{default:o(()=>e[40]||(e[40]=[y("取消")])),_:1}),a(b,{type:"primary",onClick:Ve,loading:E.value},{default:o(()=>e[41]||(e[41]=[y("创建问题")])),_:1},8,["loading"])])]),default:o(()=>[t("div",ns,[a(ze,{model:p.value,"label-position":"top",rules:fe,ref_key:"createFormRef",ref:A},{default:o(()=>[a(j,{label:"问题标题",prop:"title"},{default:o(()=>[a(g,{modelValue:p.value.title,"onUpdate:modelValue":e[5]||(e[5]=l=>p.value.title=l),placeholder:"请输入问题标题"},null,8,["modelValue"])]),_:1}),t("div",is,[a(j,{label:"优先级",prop:"priority"},{default:o(()=>[a(u,{modelValue:p.value.priority,"onUpdate:modelValue":e[6]||(e[6]=l=>p.value.priority=l),placeholder:"请选择优先级",class:"w-full"},{default:o(()=>[a(d,{label:"高优先级",value:"high"}),a(d,{label:"中优先级",value:"medium"}),a(d,{label:"低优先级",value:"low"})]),_:1},8,["modelValue"])]),_:1}),a(j,{label:"负责人",prop:"assignee"},{default:o(()=>[a(u,{modelValue:p.value.assignee,"onUpdate:modelValue":e[7]||(e[7]=l=>p.value.assignee=l),placeholder:"请选择负责人",class:"w-full"},{default:o(()=>[(v(!0),m(X,null,Z(R.value,l=>(v(),ee(d,{key:l.id,label:l.name,value:l.id},{default:o(()=>[t("div",rs,[t("div",ds,[a(C,{size:26,src:l.avatar,class:"user-avatar"},null,8,["src"]),t("span",us,i(l.name),1)]),t("span",cs,i(l.role||"用户"),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),t("div",vs,[a(j,{label:"截止日期",prop:"deadline"},{default:o(()=>[a(De,{modelValue:p.value.deadline,"onUpdate:modelValue":e[8]||(e[8]=l=>p.value.deadline=l),type:"datetime",placeholder:"请选择截止日期",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm",class:"w-full"},null,8,["modelValue"])]),_:1})]),a(j,{label:"问题描述",prop:"description"},{default:o(()=>[a(g,{modelValue:p.value.description,"onUpdate:modelValue":e[9]||(e[9]=l=>p.value.description=l),type:"textarea",rows:6,placeholder:"请输入问题描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])])}}}),hs=$e(ps,[["__scopeId","data-v-dd99982f"]]);export{hs as default};
//# sourceMappingURL=index-D3zsqnx5.js.map
